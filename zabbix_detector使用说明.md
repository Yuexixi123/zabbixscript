# Zabbix 检测工具使用说明
## 概述
zabbix_detector.py 是一个专业的 Zabbix 监控系统检测工具，用于识别和分析 Zabbix 环境中的配置问题和潜在风险。该工具能够帮助管理员快速发现非标准配置、被禁用的监控项和触发器等问题。

## 主要功能
1. 检测非模板监控项 - 识别直接在主机上创建的监控项（非从模板继承）
2. 检测非模板触发器 - 识别直接在主机上创建的触发器（非从模板继承）
3. 检测被禁用的监控项 - 找出所有被禁用的监控项
4. 检测被禁用的触发器 - 找出所有被禁用的触发器
5. 检测模板监控项中的非模板触发器 - 识别基于模板监控项但触发器为非模板的情况
6. 支持单主机和主机组检测 - 可以针对单个主机或整个主机组进行检测
7. 生成详细报告 - 输出 CSV 格式的详细报告和 TXT 格式的汇总报告
## 系统要求
- Python 3.6+
- requests 库
- Zabbix 7.2+ (支持 Bearer Token 认证)
- 网络连接到 Zabbix 服务器
## 安装依赖
```
pip3 install requests
```
## 配置说明
脚本中的 Zabbix 连接配置位于 ZabbixConfig 类中，默认配置如下：

```
self.url = "http://localhost/api_jsonrpc.php"
self.user = "Admin"
self.password = "zabbix"
self.timeout = 30
```
注意： 使用前请根据实际环境修改这些配置参数。

## 使用方法
### 基本语法
```
python3 zabbix_detector.py <模式> <目标>
```
### 检测模式 1. 按主机检测
```
python3 zabbix_detector.py host <主机名>
```
示例：

```
python3 zabbix_detector.py host 'TestHost01-Linux'
``` 2. 按主机组检测
```
python3 zabbix_detector.py hostgroup <主机组名>
```
示例：

```
python3 zabbix_detector.py hostgroup '测试主机组A - 模板替换'
python3 zabbix_detector.py hostgroup '检测工具测试组'
```
## 输出文件
工具会生成两种类型的报告文件：

### 1. 详细报告 (CSV 格式)
文件名格式： zabbix_detection_detail_<目标名称>_<时间戳>.csv

包含以下字段：

- 主机名
- 主机ID
- 问题类型
- 项目ID
- 项目名称
- 项目键值
- 状态
- 优先级
- 是否模板项
- 模板ID
- 描述
### 2. 汇总报告 (TXT 格式)
文件名格式： zabbix_detection_summary_<目标名称>_<时间戳>.txt

包含：

- 检测范围和时间
- 各类问题的统计数量
- 主机详情（主机组检测时）
- 关联模板信息
## 问题类型说明
### 1. 非模板监控项
- 定义： 直接在主机上创建的监控项，而非从模板继承
- 风险： 难以统一管理，不利于标准化
- 建议： 将常用监控项添加到模板中
### 2. 非模板触发器
- 定义： 直接在主机上创建的触发器，而非从模板继承
- 风险： 告警规则不统一，维护困难
- 建议： 将触发器规则标准化并添加到模板
### 3. 被禁用的监控项
- 定义： 状态为禁用的监控项
- 风险： 可能导致监控盲区
- 建议： 确认是否需要启用或删除
### 4. 被禁用的触发器
- 定义： 状态为禁用的触发器
- 风险： 可能错过重要告警
- 建议： 确认禁用原因，必要时启用
### 5. 模板监控项中的非模板触发器
- 定义： 基于模板监控项但触发器为非模板的情况
- 风险： 配置不一致，难以维护
- 建议： 将触发器也添加到模板中
## 日志文件
程序运行时会生成日志文件 zabbix_detector.log ，记录：

- 登录/注销信息
- 检测过程详情
- 错误和警告信息
- 报告生成状态
## 常见问题
### 1. 连接失败
- 检查 Zabbix 服务器地址和端口
- 确认用户名和密码正确
- 验证网络连接
### 2. 权限不足
- 确保使用的账户有足够的 API 权限
- 检查用户角色配置
### 3. 主机/主机组不存在
- 确认主机名或主机组名称正确
- 注意名称的大小写和特殊字符
### 4. 超时错误
- 增加 timeout 配置值
- 检查网络延迟
## 最佳实践
1. 定期检测： 建议定期运行检测工具，及时发现配置问题
2. 批量处理： 对于大型环境，建议按主机组分批检测
3. 报告分析： 重点关注非模板项和被禁用项的数量变化
4. 标准化： 根据检测结果制定监控标准化策略
5. 备份配置： 在进行配置调整前，建议备份相关配置
## 示例输出
```
检测完成 - 主机组: 检测工具测试组
==================================================
检测主机数: 3 个
非模板监控项: 5 个
非模板触发器: 2 个
被禁用的监控项: 1 个
被禁用的触发器: 0 个
模板监控项中的非模板触发器: 3 个

详细报告: zabbix_detection_detail_检测工具测试组
_20250704_093415.csv
汇总报告: zabbix_detection_summary_检测工具测试组
_20250704_093415.txt
```
## 技术支持
如遇到问题，请检查：

1. 日志文件中的错误信息
2. Zabbix API 文档
3. 网络连接状态
4. 用户权限配置
注意： 本工具仅用于检测和分析，不会修改 Zabbix 配置。在生产环境中使用前，请先在测试环境中验证。
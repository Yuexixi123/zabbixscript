# Zabbix 主机组批量更新工具使用说明
## 概述
zabbix_group_update.py 是一个用于批量修改 Zabbix 主机组名称的自动化工具。该工具支持从 CSV 文件读取配置，批量重命名主机组，并提供完整的备份和回滚功能。

## 主要功能
1. 批量重命名主机组 - 根据 CSV 文件批量修改主机组名称
2. 智能前缀匹配 - 自动匹配带前缀的主机组名称（a_、b_、c_ 等）
3. 主机迁移功能 - 支持将主机迁移到"下线"组
4. 自动备份 - 操作前自动备份所有主机组和主机信息
5. 空组清理 - 自动清理操作后的空主机组
6. 前缀保留 - 重命名时自动保留原有前缀
7. 回滚功能 - 支持基于备份文件的完整回滚
## 系统要求
- Python 3.6+
- requests 库
- Zabbix 7.2+ (支持 Bearer Token 认证)
- 网络连接到 Zabbix 服务器
## 安装依赖
```
pip3 install requests
```
## 配置说明
脚本顶部的配置参数需要根据实际环境修改：

```
ZABBIX_URL = 'http://127.0.0.1/api_jsonrpc.php'
USERNAME = 'Admin'
PASSWORD = 'zabbix'
```
注意： 使用前请确保修改为正确的 Zabbix 服务器地址、用户名和密码。

## CSV 文件格式
工具需要一个名为 group_changes.csv 的 CSV 文件，包含以下字段：

字段名 说明 示例 原系统名称 当前主机组名称 测试环境组 修改后系统名称 目标主机组名称 生产环境组

### CSV 文件示例
```
原系统名称,修改后系统名称
测试环境组,生产环境组
a_开发组,开发测试组
b_临时组,下线
无需修改的组,无需修改
```
### 特殊值说明
- "无需修改" - 跳过该行，不进行任何操作
- "下线" - 将主机组中的所有主机迁移到"下线"组，并删除原空组
- 空值 - 自动跳过空值行
## 使用方法
### 1. 准备 CSV 文件
在脚本同目录下创建 group_changes.csv 文件，按照上述格式填写需要修改的主机组信息。

### 2. 执行批量更新
```
python3 zabbix_group_update.py
```
### 3. 执行过程
工具会按以下步骤执行：

1. 登录验证 - 连接 Zabbix 服务器并获取认证令牌
2. 读取配置 - 解析 CSV 文件，验证数据格式
3. 全量备份 - 备份所有主机组和主机关联信息
4. 批量处理 - 逐一处理每个重命名请求
5. 清理空组 - 自动删除操作后的空主机组
## 功能特性详解
### 智能前缀匹配
工具支持自动匹配带前缀的主机组：

- 首先尝试精确匹配原名称
- 如果失败，自动尝试 a_、b_、c_ 等前缀匹配
- 支持 26 个字母前缀（a_ 到 z_）
### 前缀保留机制
重命名时自动保留原有前缀：

```
原名称: a_测试组
目标名称: 生产组
最终结果: a_生产组
```
### 主机迁移功能
当目标名称为"下线"时：

1. 将原主机组中的所有主机迁移到"下线"组
2. 如果"下线"组不存在，自动创建
3. 标记原主机组用于后续清理
### 空组自动清理
操作完成后自动清理：

- 检查标记的主机组是否为空
- 删除确认为空的主机组
- 记录清理结果
## 备份文件
每次执行都会生成备份文件：

- 文件名格式： group_backup_YYYYMMDD_HHMMSS.json
- 内容： 所有主机组信息和主机关联关系
- 用途： 支持完整回滚操作
### 备份文件结构
```
{
  "主机组名称": {
    "groupid": "组ID",
    "hosts": [
      {
        "hostid": "主机ID",
        "name": "主机名称"
      }
    ]
  }
}
```
## 回滚功能
脚本底部包含回滚功能代码（默认注释）：

### 启用回滚
1. 取消注释回滚相关代码
2. 修改 main 函数调用为回滚函数
3. 指定备份文件名
```
if __name__ == '__main__':
    token = get_auth_token()
    rollback_group_names('group_backup_20250702_153503.
    json', token)
```
### 回滚功能
- 恢复所有主机组名称
- 重新创建已删除的主机组
- 恢复主机与主机组的关联关系
- 从"下线"组移回原主机组
## 日志记录
工具会生成详细的日志文件 group_update.log ，记录：

- 操作时间和结果
- 错误和警告信息
- 备份和回滚详情
- API 调用状态
## 输出示例
```
开始备份所有分组和主机信息...
[备份] 分组: 测试环境组 (ID: 123), 主机数量: 5
[备份] 分组: a_开发组 (ID: 124), 主机数量: 3
备份完成，保存文件: group_backup_20250704_140530.json

正在处理第 1/2 条记录，目标名称：'生产环境组'，原系统名称列表：['测
试环境组']
  正在修改分组：'测试环境组' -> '生产环境组'
[成功] 分组 '测试环境组' 重命名为 '生产环境组'

正在处理第 2/2 条记录，目标名称：'下线'，原系统名称列表：['a_开发组
']
  正在修改分组：'a_开发组' -> '下线'
[迁移] 将分组 'a_开发组' 中 3 个主机移动到 '下线'

开始清理空的主机群组...
[删除成功] 空群组 'a_开发组' 已删除
✅ 清理完成，共删除 1 个空群组

✅ 所有操作完成，备份文件：group_backup_20250704_140530.json
```
## 错误处理
### 常见错误及解决方案
1. 连接失败
   
   - 检查 Zabbix 服务器地址和端口
   - 确认网络连接正常
2. 认证失败
   
   - 验证用户名和密码
   - 确认用户有足够的 API 权限
3. 主机组不存在
   
   - 检查 CSV 文件中的主机组名称
   - 确认前缀匹配规则
4. 权限不足
   
   - 确保用户有主机组管理权限
   - 检查 Zabbix 用户角色配置
### 错误日志示例
```
[未找到] 原分组：不存在的组（已尝试所有前缀）
[失败] 分组 '测试组' 重命名为 '新名称' 出错：权限不足
[删除失败] 群组 '空组' 删除失败：API错误
```
## 最佳实践
1. 操作前准备
   
   - 仔细检查 CSV 文件内容
   - 确认 Zabbix 连接配置
   - 在测试环境先验证
2. 批量操作
   
   - 分批处理大量主机组
   - 避免在业务高峰期操作
   - 保留足够的备份文件
3. 安全措施
   
   - 定期备份 Zabbix 配置
   - 测试回滚功能
   - 记录操作日志
4. 性能优化
   
   - 脚本内置 0.1 秒延时避免过快请求
   - 大量操作时可适当增加延时
## 注意事项
⚠️ 重要提醒：

1. 生产环境使用前务必在测试环境验证
2. 确保备份文件安全保存
3. 操作前确认 CSV 文件内容正确
4. 建议在维护窗口期间执行
5. 保持网络连接稳定
## 技术支持
如遇问题，请检查：

1. 日志文件 group_update.log 中的详细错误信息
2. Zabbix API 文档和权限配置
3. 网络连接和服务器状态
4. CSV 文件格式和内容
版本信息： 适用于 Zabbix 7.2+ 版本 最后更新： 2025年1月

免责声明： 本工具仅供学习和测试使用，生产环境使用请充分测试并做好备份。